<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>VTI &lt;+&gt; Benis Finanzen</title>
<script src="jquery-3.3.1.min.js"></script>
<script src="gimli-parser.js"></script>
<script src="vti.js"></script>
<link href="https://fonts.googleapis.com/css?family=Permanent+Marker&display=swap" rel="stylesheet"> 
<style type="text/css">
	html, body
	{
		background-color: #000033;
		color: #FFFFFA;
		margin: 0;
		padding: 0;
	}
	
	.deckel
	{
		background-image: url('deckel.png');
		background-repeat: no-repeat;
		width: 150px;
		height: 151px;
		text-align: center;
		color: #3333CC;
		font-family: "Permanent Marker", serif;
		font-size: 26pt;
		padding-top: 50px;
	}
	/* fullbalanz -> working */
	.fullbalanz_w
	{
		background-image: url('fabrik.gif');
		background-repeat: no-repeat;
		width: 100px;
		height: 110px;
		text-align: center;
		padding-top: 65px;
		font-size: 16pt;
	}
	
	a, a:visited
	{
		color: #FFAA00;
	}
	a:hover
	{
		color: #FFFF33;
	}
	.btn, .btn:visited
	{
		padding-left: 5px;
		padding-right: 5px;
		background-color: #FFAA00;
		color: #000033;
		text-decoration: none;
	}
	.btn:hover
	{
		background-color: #000033;
		color: #FFFF33;
		text-decoration: none;
	}
	.btngreen, .btngreen:visited
	{
		padding-left: 5px;
		padding-right: 5px;
		background-color: #00AA00;
		color: #000033;
		text-decoration: none;
	}
	.btngreen:hover
	{
		background-color: #000033;
		color: #00AA00;
		text-decoration: none;
	}
	.btnred, .btnred:visited
	{
		padding-left: 5px;
		padding-right: 5px;
		background-color: #AA0000;
		color: #FFFFFA;
		text-decoration: none;
	}
	.btnred:hover
	{
		background-color: #FFFFFA;
		color: #AA0000;
		text-decoration: none;
	}

	.fw
	{
		min-width: 99%;
	}
	.tdr {text-align: right;}
	#ubermenu
	{
		padding-bottom: 10px;
		margin-bottom: 10px;
		border-bottom: 1px solid #FFFFFA;
		font-size: 15pt;
		font-weight: bold;
	}
	
	/* ui window for deletion of entries. */
	#deleteWindow
	{
		position: absolute;
		top: 10px;
		right: 30px;
		display: block;
		width: 200px;
		height: 120px;
		z-index: 100;
		border: 2px solid #FFFFFA;
		background-color: #000033;
		border-radius: 3px;
		padding: 10px;
		display: none;
	}
	
	.fifty
	{
		width: 50px;
	}
	
	#buysellwindow
	{
		border: 2px solid #FFFFFA;
		border-radius: 3px;
		width: 280px;
		height: 80px;
	}
	
	/* show the gesamt value also in the upper right.*/
	#obergesamtfeld
	{
		position: absolute;
		top: 10px;
		right: 10px;
	}
	
	/*blocker stuff*/
	#blocker
	{
		position: absolute;
		top: 0px;
		left: 0px;
		padding: 0;
		margin: 0;
		width: 100%;
		height: 100%;
		background-color: #000069;
		z-index: 1000;
		display: none;
	}
	
	/* content of the blocker, centered. */
	#blockercontent
	{
		position: absolute;
		margin: 0 auto;
		width: 400px;
		text-align: center;
		font-size: 30pt;
		font-family: monospace;
		top: 50%;
		left: 50%;
		-ms-transform: translate(-50%, -50%); /* IE 9 */
		-webkit-transform: translate(-50%, -50%); /* Safari prior 9.0 */
		transform: translate(-50%, -50%); /* Standard syntax */
		min-height: 70px;
	}
	
	/* status text for the blocker. */
	#blocker_text
	{
		width: 100%;
		text-align: center;
		font-size: 12pt;
		font-family: monospace;
	}
</style>
</head>
<body>
	<div id="blocker">
		<div id="blockercontent">
			Bitte warten..
			<div id="blocker_text">
				Etwas passiert.
			</div>
		</div>
	</div>
	
	<div id="deleteWindow"></div>
	<div id="pagetitle">
		<div id="title">
		<h1>Volle Transparenz Initiative</h1>
		<h2>Benis Projektfinanzen</h2>
		</div>
	</div>
	<div id="obergesamtfeld">Wert wird berechnet..</div>
	<div id="pagecontent">
		Bitte warten...Daten werden geladen.
	</div>
</body>

<script>

// set loglevel.
log.loglevel = LOG_WARN;

// save a new transaction from the input fields.
var g_projectID = -1;
function addTransaction()
{
	var desc = $('#input_transaction_desc').val();
	var link = $('#input_transaction_productlink').val();
	var rein = parseFloat($('#input_transaction_rein').val());
	var raus = parseFloat($('#input_transaction_raus').val());
	if(isNaN(rein))
		rein=0;
	if(isNaN(raus))
		raus=0;
	var projectid = $('#input_transaction_projectid').val();
	if(g_projectID!=-1)
		projectid = g_projectID;
	var dt = new Date();
	log("Add: "+rein+"-"+raus+": "+desc+" / "+link+" @for: "+projectid);

	createTransaction(projectid, desc,link, rein, raus, dt, 'transactions');
}

// generic function for creating a new transaction.
function createTransaction(projectid, desc, link, rein, raus, date, loadtable = 'transactions')
{
	showBlocker("Erstelle Transaktion: "+desc, true);
	var data = {PROJECTID: projectid,
		DESC: desc,
		LINK: link,
		REIN: rein,
		RAUS: raus,
		DATE: date.toString(),
		whichtable: 'TRANSACTIONS',
		CUD: 'create'
				};			// the CUD event to do.
					// ^if CUD == 'create', it will create OR update an object.
					// if CUD == 'delete', it will delete the object.
		
	// success function.
	var success = function(data)
	{
		console.log("CUD event result:" +data);
		loadTable(loadtable);
		showBlocker("", false);
		// hideBlocker(); render will load all events and show blocker in the meanwhile.
	}

	$.ajax({
		type: 'POST',
		url: 'ajax_CUD_event.php',
		data: data,
		success: success,
		error: success,
		dataType: 'text'
	});
}

// save a new project.
function addProject()
{
	var name = $('#input_project_name').val();
	var link = $('#input_project_link').val();
	var desc = $('#input_project_desc').val();
	var date = new Date();
	log("Add: "+name+"/ "+desc+" / "+link);
	
	var data = {DESC: desc,
		LINK: link,
		NAME: name,
		DATE: date.toString(),
		whichtable: 'PROJECTS',
		CUD: 'create'
	};	// the CUD event to do.
		// ^if CUD == 'create', it will create OR update an object.
		// if CUD == 'delete', it will delete the object.
		
	// success function.
	var success = function(data)
	{
		console.log("CUD event result:" +data);
		loadTable('projects');
		// hideBlocker(); render will load all events and show blocker in the meanwhile.
	}

	$.ajax({
		type: 'POST',
		url: 'ajax_CUD_event.php',
		data: data,
		success: success,
		dataType: 'text'
	});
}

// create an all new inventory item.
function createInventoryItem()
{
	var name = $('#input_inventory_name').val();
	var desc = $('#input_inventory_desc').val();
	var projectid = $('#input_inventory_projectid').val();
	var price = $('#input_inventory_price').val();
	var amount = 0;
	log("Creating item "+name+" => "+desc+" @ "+projectid);

	var data = {
		NAME: name,
		DESC: desc,
		PROJECTID: projectid,
		AMOUNT: 0,
		PRICE: price,
		whichtable: 'INVENTORY',
		CUD: 'create'
	};	// the CUD event to do.
		// ^if CUD == 'create', it will create OR update an object.
		// if CUD == 'delete', it will delete the object.
		
	// success function.
	var success = function(data)
	{
		console.log("CUD event result:" +data);
		loadTable('inventory');
		// hideBlocker(); render will load all events and show blocker in the meanwhile.
	}

	$.ajax({
		type: 'POST',
		url: 'ajax_CUD_event.php',
		data: data,
		success: success,
		dataType: 'text'
	});
}

// save a new deckel.
var g_deckelName = -1;
function addDeckel()
{
	var name = $('#input_deckel_name').val();
	if(g_deckelName!=-1)
		name = g_deckelName;
	g_deckelName=-1;
	var produkt = $('#input_deckel_product').val();
	var projid=$('#input_deckel_project').val();
	if(isNaN(projid))
		projid = 0;
	var summe = $('#input_deckel_summe').val();
	if(isNaN(summe))
		summe=0;
	var date = new Date();
	log("Add: "+name+"/ "+produkt+" / "+summe);
	
	var data = {
		NAME: name,
		PROJECTID: projid,
		PRODUKT: produkt,
		DATE: date.toString(),
		SUMME: summe,
		whichtable: 'DECKELS',
		CUD: 'create'
	};	// the CUD event to do.
		// ^if CUD == 'create', it will create OR update an object.
		// if CUD == 'delete', it will delete the object.
		
	// success function.
	var success = function(data)
	{
		console.log("CUD event result:" +data);
		loadTable('deckels');
		// hideBlocker(); render will load all events and show blocker in the meanwhile.
	}

	$.ajax({
		type: 'POST',
		url: 'ajax_CUD_event.php',
		data: data,
		success: success,
		dataType: 'text'
	});
}

// show the intermediary delete UI.
function showDeleteWindow(whichtable, id, caller)
{
	var txt = "";
	txt+="Eintrag-ID #"+id+" wirklich von "+whichtable+" löschen?<br />";
	txt+="(Damit verknüpfte Einträge werden nicht gelöscht!)<br /><br />";
	txt+="<a href='javascript:' class='btnred' onclick='hideDeleteWindow();deleteEntry(\""+whichtable+"\","+id+")'>Löschen</a> | <a href='javascript:' class='btngreen' onclick='hideDeleteWindow();'>Abbrechen</a>";
	txt+="";
	
	$('#deleteWindow').html(txt);
	var left=caller.offset().left-$('#deleteWindow').width();
	if(left<0)
		left = 0;
	$('#deleteWindow').css('top',(caller.offset().top-($('#deleteWindow').height()*0.5))+'px');
	$('#deleteWindow').css('left',left+'px');
	$('#deleteWindow').show(txt);
}

function hideDeleteWindow()
{
	$('#deleteWindow').hide();
}

// delete the entry with given id from given table.
function deleteEntry(whichtable, id)
{
	var data = {ID: id,
		whichtable: whichtable,
		CUD: 'delete'
		};			// the CUD event to do.
					// ^if CUD == 'create', it will create OR update an object.
					// if CUD == 'delete', it will delete the object.
		
	// success function.
	var success = function(data)
	{
		console.log("CUD event result:" +data);
		loadTable(whichtable.toLowerCase());
		// hideBlocker(); render will load all events and show blocker in the meanwhile.
	}

	$.ajax({
		type: 'POST',
		url: 'ajax_CUD_event.php',
		data: data,
		success: success,
		dataType: 'text'
	});
}

// show all inventory or only the one for a specific project.
function showInventoryTable(proid)
{
	var parser = GMLParser.getParser("DataParser");
	var txt="";
	txt+="<table border='1'>";
	txt+="<tr><td>";
	txt+="ID";
	txt+="</td><td>";
	txt+="Name";
	txt+="</td><td>";
	txt+="Beschreibung";
	txt+="</td><td>";
	
	txt+="Projekt";
	txt+="</td><td>";
	
	txt+="Standardpreis";
	txt+="</td><td>";	
	
	txt+="Anzahl";
	txt+="</td><td>";
	txt+="!DEL!";
	txt+="</td></tr>";

// add the inputs for a new item.
	txt+='<tr><td>';
	txt+='<a href="javascript:" class="btn fw" onclick="createInventoryItem();">NEU =&gt;</a>';
	txt+='</td><td>';
	txt+="<input type='text' class='fw' id='input_inventory_name' />";
	txt+='</td><td>';
	txt+="<input type='text' class='fw' id='input_inventory_desc' />";
	txt+='</td><td>';
	txt+="<select name='projectselector' class='fw' id='input_inventory_projectid'>";
	for(var i=0;i<parser.projects.length;i++)
	{
		var p = parser.projects[i];
		var sel="";
		if(i==proid)
			sel='selected="selected"';
		txt+='<option value="'+p.id+'" '+sel+'>'+p.id+": "+p.name+'</option>';
	}
	txt+="</select>";
	txt+="</td><td>";
	txt+="<input type='text' class='fw' id='input_inventory_price' value='0.00' />";
	txt+="</td><td>";	
	txt+='<a href="javascript:" class="btn fw" onclick="createInventoryItem();">&lt;= NEU</a>';
	txt+="</td><td>";
	txt+="! v !";
	txt+='</td></tr>';

	var o = "";
	
	for(var i=0;i<parser.inventory.length;i++)
	{
		var itm = parser.inventory[i];
		txt+='<tr><td>';
		txt+=itm.id;
		txt+='</td><td>';
		txt+=itm.name;
		txt+='</td><td>';
		txt+=itm.desc;
//		if(proid>=0)
//		{
			txt+='</td><td>';
			txt+="["+itm.projectid+"] "+getProjectByID(itm.projectid).name;
//		}
		txt+='</td><td>';
		txt+=parseFloat(itm.price).toFixed(2);
		txt+='</td><td>';
		txt+=itm.amount;
		txt+='</td><td>';
		txt+='<a href="javascript:" class="btnred fw" onclick="showDeleteWindow(\'INVENTORY\','+itm.id+',$(this));">!DEL!</a>';
		txt+='</td></tr>';
		o+="<option value='"+itm.id+"'>["+itm.id+"] "+itm.name+"</option>";
	}
	
	txt+="</table>";

	// set obergesamtfeld.
	var invval = 0.0;
	
	var g = '<div id="buysellwindow">';
	if(o=="")
	{
		g+="Bitte erst ein Produkt erstellen.";
	}else{
		invval = parser.inventory[0].price;
		g+="<table border='0'><tr><td colspan='6'>";
		g+= "<select id='input_buysell_itemid' class='fw' oninput='inventorychange(1);'>";
		g+=o;
		g+="</select></td></tr>";
		g+='<tr><td><input class="fifty" id="input_buysell_amount" type="text" placeholder="Anzahl" value="1" oninput="inventorychange(2);" /></td><td> * </td>';
		g+='<td><input class="fifty" id="input_buysell_itemprice" type="text" placeholder="Stückpreis" value="'+invval+'" oninput="inventorychange(3);" /></td><td>CHF = </td>';
		g+='<td><input class="fifty" id="input_buysell_gesamtprice" type="text" placeholder="Gesamtpreis" value="'+invval+'" oninput="inventorychange(4);" /></td><td>CHF</td></tr>';
		g+='<tr><td colspan="3"></td><td colspan="3"><a href="javascript:" onclick="BuySellInventory(1);" class="btn">&lt;= &#8383;U&yen;</a> | ';
		g+='<a href="javascript:" onclick="BuySellInventory(0);" class="btngreen">&dollar;&euro;&pound;&pound; =&gt;</a></td></tr>';
		g+='</div>';
	}
	g+='</div>';
	document.getElementById('obergesamtfeld').innerHTML=g;

	return txt;
}

// start a buy or sell transaction.
function BuySellInventory(which)
{
	var rein = 0;
	var raus = 0;
	var itemid = parseInt($('#input_buysell_itemid').val());
	var fullprice = parseFloat($('#input_buysell_gesamtprice').val());
	var itemprice = parseFloat($('#input_buysell_itemprice').val());
	var amount = parseFloat($('#input_buysell_amount').val());
	
	var itm = getInventoryItemByID(itemid);
	
	if(isNaN(fullprice) || isNaN(itemprice) || isNaN(amount) || itemid<0)
	{
		log("NaN ERROR: Transaction Not Done.", LOG_ERROR);
		return;
	}
		
	// add or remove the amount.
	if(which==1)
	{
		raus = fullprice;
		itm.amount+=amount;
		showBlocker("Packe "+amount+" "+itm.name+" ins Inventar");
		log("Added "+amount+" items to "+itm.name);
	}else{
		showBlocker("Entferne "+amount+" "+itm.name+" aus dem Inventar");
		rein = fullprice;
		if(itm.amount-amount<0)
		{
			log("Not enough items in inventory, transaction not done!", LOG_ERROR);
			showBlocker("", false);
			return;
		}
		itm.amount = itm.amount - amount;
		log("Removed "+amount+" items from "+itm.name);
	}
	
	// update the item
	var data = {
		ID: itemid,
		NAME: itm.name,
		DESC: itm.desc,
		PROJECTID: itm.projectid,
		AMOUNT: itm.amount,
		PRICE: itm.price,
		whichtable: 'INVENTORY',
		CUD: 'update'
	};			// the CUD event to do.
					// ^if CUD == 'create', it will create OR update an object.
					// if CUD == 'delete', it will delete the object.
					
	// success function.
	var success = function(data)
	{
		console.log("item updated:" +data);
		//loadTable('inventory');
		//showBlocker("",false);
		
		var desc ="";
		if(which==1)
		{
			desc=amount+" neue "+itm.name+" ins Inventar gepackt zum Preis von "+itemprice+"/Einheit.";
		}else{
			desc=amount+" "+itm.name+ " aus dem Inventar entfernt zum Preis von "+itemprice+"/Einheit.";
		}
		
		var dt = new Date();
		createTransaction(itm.projectid, desc, "", rein, raus, dt,"inventory");
	}
	
	// error function.
	var error = function(data)
	{
		console.log("ERROR item NOT updated:" +data);
		loadTable('inventory');
		showBlocker("",false);
	}

	$.ajax({
		type: 'POST',
		url: 'ajax_CUD_event.php',
		data: data,
		success: success,
		error: error,
		dataType: 'text'
	});
}

// some field in the upper window in the inventory field has changed.
var g_invchangelocked = false;
function inventorychange(whichfield)
{
	if(!g_invchangelocked)
		g_invchangelocked=true;
	else
		return;
		
	var amount = parseFloat($('#input_buysell_amount').val());
	if(isNaN(amount))
		amount = 0;
		
	var itemprice = parseFloat($('#input_buysell_itemprice').val());
	if(isNaN(itemprice))
		itemprice = 0;
	
	var gesamtprice = parseFloat($('#input_buysell_gesamtprice').val());
	if(isNaN(gesamtprice))
		gesamtprice = 0;
		
	switch(whichfield)
	{
		case 1:
			// get the item price from the inventory item.
			var itm = getInventoryItemByID($('#input_buysell_itemid').val());
			itemprice = itm.price;
			gesamtprice = amount*itemprice;
			$('#input_buysell_gesamtprice').val(gesamtprice);
			$('#input_buysell_itemprice').val(itemprice);
			break;
		case 2:
		case 3:
			gesamtprice = amount*itemprice;
			$('#input_buysell_gesamtprice').val(gesamtprice);
			break;
		case 4:
			if(amount==0 || gesamtprice==0)
				itemprice = 0.0;
			else
				itemprice = gesamtprice/amount;
			$('#input_buysell_itemprice').val(itemprice);
			break;
		default:
			break;
	}

	g_invchangelocked=false;
}

// show all transactions or only the ones for a specific project.
function showTransactions(proid)
{
	var parser = GMLParser.getParser("DataParser");

	var colsp = 4;
	
	var txt = "";
	txt+= '<table border="1">';
	txt+="<tr><td>";
	txt+="ID";
	txt+="</td><td>";
	txt+="Datum";
	txt+="</td><td>";
	txt+="Beschreibung";
	txt+="</td><td>";
	if(proid<0)
	{
		txt+="Projekt-ID";
		txt+="</td><td>";
		colsp+=1;
	}
	txt+="Produktlink";
	txt+="</td><td>";	
	txt+="REIN";
	txt+="</td><td>";
	txt+="RAUS";
	txt+="</td><td>";
	txt+="GESAMT";
	txt+="</td><td>";
	txt+="!DEL!";
	txt+="</td></tr>";

	// add the inputs
	txt+="<tr><td>";
	txt+="<a href='javascript:' class='btn' onclick='addTransaction();'><nobr>NEU =&gt;</nobr></a>";
	txt+="</td><td>";
	txt+="(auto)";
	txt+="</td><td>";
	txt+="<input type='text' class='fw' id='input_transaction_desc' />";
	txt+="</td><td>";
	if(proid<0)
	{
		txt+="<select name='projectselector' class='fw' id='input_transaction_projectid'>";
		for(var i=0;i<parser.projects.length;i++)
		{
			var p = parser.projects[i];
			txt+='<option value="'+p.id+'">'+p.id+": "+p.name+'</option>';
		}
		txt+="</select>";
		txt+="</td><td>";
		g_projectID = -1;
	}else{
		g_projectID = proid;
	}
	txt+="<input type='text' class='fw' id='input_transaction_productlink' />";
	txt+="</td><td>";	
	txt+="<input type='text' class='fw' id='input_transaction_rein' />";
	txt+="</td><td>";
	txt+="<input type='text' class='fw' id='input_transaction_raus' />";
	txt+="</td><td>";
	txt+="<a href='javascript:' class='btn' onclick='addTransaction();'><nobr>&lt;= NEU</nobr></a>";
	txt+="</td><td>! v !";
	txt+="</td></tr>";
	
	var gesamtvalue = 0;
	var gesamtrein = 0;
	var gesamtraus = 0;
	for(var i = parser.transactions.length-1; i>=0; i--)
	{
		var t = parser.transactions[i];
		if(proid>=0 && t.projectid!=proid)
			continue;
		txt+="<tr><td>";
		txt+=t.id;
		txt+="</td><td>";
		txt+=t.datum.getDate()+"."+(t.datum.getMonth()+1)+"."+t.datum.getFullYear();
		txt+="</td><td>";
		txt+=t.desc;
		if(proid<0)
		{
			var prname = getProjectByID(t.projectid).name;
			txt+="</td><td><a href='javascript:' onclick='g_idToShow="+t.projectid+";singleProjectLoaded();'>["+t.projectid+"] "+prname+"</a>";
		}
		txt+="</td><td>";
		if(t.link.length>0)
		{
			txt+='<a href="'+t.link+'" target="vti_productlink">[Link]</a>';
		}else{
			txt+="---";
		}
		txt+="</td><td class='tdr'><font color='#33FF33'>";
		if(t.in!=0)
			txt+=Math.abs(parseFloat(t.in)).toFixed(2);
		txt+="</font></td><td class='tdr'><font color='#FF3333'>";
		if(t.out!=0)
			txt+=Math.abs(parseFloat(t.out)).toFixed(2);
		var q = t.in-t.out;
		var col = "#33FF33";
		if(q<0)
			col="#FF3333";
		txt+="</font></td><td class='tdr'><font color='"+col+"'>";
		txt+=parseFloat(q).toFixed(2);
		txt+="</font></td>";
		txt+="<td><a href='javascript:' class='btnred' onclick='showDeleteWindow(\"TRANSACTIONS\","+t.id+", $(this))'>!DEL!</a>";
		txt+="</tr>";
		gesamtrein+=t.in;
		gesamtraus+=t.out;
		gesamtvalue+=q;
	}
	
	txt+='<tr>';
	txt+='<td colspan="'+colsp+'"></td>';
	col='#33FF33';
	if(gesamtvalue<0)
		col='#FF3333';

	var gesamttxt = "";
	gesamttxt+='<td class="tdr"><font color="#33FF33">'+parseFloat(gesamtrein).toFixed(2)+'</font></td>';
	gesamttxt+='<td class="tdr"><font color="#FF3333">'+parseFloat(gesamtraus).toFixed(2)+'</font></td>';
	gesamttxt+='<td class="tdr"><font color="'+col+'">'+parseFloat(gesamtvalue).toFixed(2)+'</font></td>';
	gesamttxt+='</tr>';
	gesamttxt+='</table>';

	txt+=gesamttxt;
	
	// set obergesamtfeld.
	var g = "<table border='1'><tr><td>REIN</td><td>RAUS</td><td>DIFF</td></tr><tr>"+gesamttxt;
	document.getElementById('obergesamtfeld').innerHTML=g;
	
	return txt;
}

function projectsLoaded()
{
	log("Projects loaded.");
	var parser = GMLParser.getParser("DataParser");

	var txt="";
	txt+=showTopBar(2);

	txt+='<table border="1">';
	txt+="<tr><td>";
	txt+="ID";
	txt+="</td><td>";
	txt+="Name";
	txt+="</td><td>";
	txt+="Beschreibung";
	txt+="</td><td>";
	txt+="Link";
	txt+="</td><td>";
	txt+="Balanz";
	txt+="</td><td>";
	txt+="!DEL!";
	txt+="</td></tr>";

	// add the inputs
	txt+="<tr><td>";
	txt+="<a href='javascript:' class='btn' onclick='addProject();'><nobr>NEU =&gt;</nobr></a>";
	txt+="</td><td>";
	txt+="<input type='text' id='input_project_name' class='fw' />";
	txt+="</td><td>";
	txt+="<input type='text' id='input_project_desc' class='fw' />";
	txt+="</td><td>";
	txt+="<input type='text' id='input_project_link' class='fw' />";
	txt+="</td><td>";
	txt+="<a href='javascript:' class='btn' onclick='addProject();'><nobr>&lt;= NEU</nobr></a>";
	txt+="</td><td>";
	txt+="! v !";
	txt+="</td></tr>";

	var fullbalanz = 0;
	var col = "";
	for(var i = 0; i < parser.projects.length; i++)
	{
		var p = parser.projects[i];
		txt+="<tr><td><a href='javascript:' onclick='g_idToShow="+p.id+";singleProjectLoaded();'>["+p.id+"]</a>";
		txt+="</td><td><a href='javascript:' onclick='g_idToShow="+p.id+";singleProjectLoaded();'>"+p.name+"</a>";
		var balanz = 0;
		col="#33FF33";
		for(var pq = 0; pq<parser.transactions.length;pq++)
		{
			var t = parser.transactions[pq];
			if(t.projectid==p.id)
			{
				balanz=balanz+t.in-t.out;
			}
		}
		if(balanz<0)
			col="#FF3333";
		txt+="</td><td>"+p.desc;
		txt+="</td><td><a href='"+p.link+"'>"+p.link+"</a>";
		txt+="</td><td class='tdr'><font color='"+col+"'>"+parseFloat(balanz).toFixed(2)+"</font>";
		txt+="</td><td><a href='javascript:' class='btnred' onclick='showDeleteWindow(\"PROJECTS\","+p.id+", $(this))'>!DEL!</a>";
		txt+="</tr>";
		fullbalanz+=balanz;
	}
	col="#33FF33";
	if(fullbalanz<0)
		col="#FF3333";
	txt+='<tr><td colspan="4"></td><td class="tdr"><font color="'+col+'">'+parseFloat(fullbalanz).toFixed(2)+'</font></td><td></td></tr>';
	txt+='</table>';
	document.getElementById("obergesamtfeld").innerHTML="<div class='fullbalanz_w'><font color='"+col+"'>"+parseFloat(fullbalanz).toFixed(2)+"</font></div>";
	document.getElementById("pagecontent").innerHTML=txt;

	showBlocker("", false);
}

function showDeckelStandards(which, ommitname=false,deckel = null, projectid=0)
{
	var txt="";
	// table header
	if(which==0)
	{
		txt+='<table border="1">';
		txt+="<tr><td>";
		txt+="&yen;&euro;&dollar; &lt;=";
		txt+="</td><td>";
		txt+="ID";
		txt+="</td><td>";
		txt+="Datum";
		txt+="</td><td>";
		if(!ommitname)
		{
			txt+="Name";
			txt+="</td><td>";
		}
		txt+="Produkt";
		txt+="</td><td>";
		txt+="Projekt";
		txt+="</td><td>";
		txt+="Deckelsumme";
		txt+="</td><td>";
		txt+="=&gt; &yen;&euro;&dollar;";
		txt+="</td><td>";
		txt+="!DEL!";
		txt+="</td></tr>";

		// add the inputs
		txt+="<tr><td>"
		txt+="<a href='javascript:' class='btn' onclick='addDeckel();'><nobr>NEU =&gt;</nobr></a>";
		txt+="</td><td>";
		txt+="<a href='javascript:' class='btn' onclick='addDeckel();'><nobr>NEU =&gt;</nobr></a>";
		txt+="</td><td>(auto)</td><td>";
		if(!ommitname)
		{
			txt+="<input type='text' id='input_deckel_name' class='fw' />";
			txt+="</td><td>";
		}
		txt+="<input type='text' id='input_deckel_product' class='fw' />";
		txt+="</td><td>";
		txt+="<select id='input_deckel_project' class='fw'>";
		var parser = GMLParser.getParser("DataParser");
		for(var qq=0;qq<parser.projects.length;qq++)
		{
			var p = parser.projects[qq];
			var sel="";
			if(p.id==projectid)
				sel="selected='selected'";
			txt+="<option value='"+p.id+"' "+sel+" >["+p.id+"] "+p.name+"</option>";
		}
		txt+="</select>"
		txt+="</td><td>";
		txt+="<input type='text' id='input_deckel_summe' class='fw' />";
		txt+="</td><td>";
		txt+="<a href='javascript:' class='btn' onclick='addDeckel();'><nobr>&lt;= NEU</nobr></a>";
		txt+="</td><td>";
		txt+="! v !";
		txt+="</td></tr>";
	}
	// entry
	if(which==1)
	{
		txt+="</td><td><a href='javascript:' class='btngreen fw' onclick='luepfDeckel("+deckel.id+")'>&nbsp;&yen;&euro;&dollar; &lt;=&nbsp;</a>";
		txt+="</td><td>"+deckel.id+"</a>";
		txt+="</td><td>"+deckel.datum.getDate()+"."+(deckel.datum.getMonth()+1)+"."+deckel.datum.getFullYear();
		if(!ommitname)
			txt+="</td><td><a href='javascript:' onclick='g_idToShow="+deckel.id+";loadDeckelsForID();'>"+deckel.name+"</a>";
		
		txt+="</td><td>"+deckel.produkt;
		txt+="</td><td>["+deckel.projectid+"] "+getProjectByID(deckel.projectid).name;
		txt+="</td><td>"+parseFloat(deckel.summe).toFixed(2);
		txt+="</td><td><a href='javascript:' class='btngreen fw' onclick='luepfDeckel("+deckel.id+")'>&nbsp;=&gt; &yen;&euro;&dollar;&nbsp</a>";
		txt+="</td><td><a href='javascript:' class='btnred' onclick='showDeleteWindow(\"DECKELS\","+deckel.id+", $(this))'>!DEL!</a>";
		txt+="</tr>";
	}
	return txt;
}

// complete a deckel, make a transaction out of it.
function luepfDeckel(deckelid)
{
	log("Deckel wird gelüpft..");
	var parser = GMLParser.getParser("DataParser");
	var deckel = null;
	for(var i = 0;i<parser.deckels.length;i++)
	{
		var d = parser.deckels[i];
		if(d.id==deckelid)
		{
			deckel = d;
			break;
		}
	}

	if(deckel==null)
	{
		log("Deckel mit ID "+deckelid+" nicht gefunden.", LOG_WARN);
		return;
	}
	
	if(isNaN(parseFloat(deckel.summe)))
		deckel.summe = 0;
		
	var desc = "D: "+deckel.name+" erstattet vorbezogenes "+deckel.produkt+" vom "+deckel.datum.getDate()+"."+(deckel.datum.getMonth()+1)+"."+deckel.datum.getFullYear();
	desc+=" für "+parseFloat(deckel.summe).toFixed(2)+"CHF";
	var link = "";
	var rein = parseFloat(deckel.summe);
	var raus = 0;
	if(isNaN(rein))
		rein=0;
	var projectid = deckel.projectid;
	// actual date.
	var dt = new Date();
	log("Transaktionsdeckel: "+rein+": "+desc+" @for: "+projectid);
	log("Add : "+rein+"-"+raus+": "+desc+" / "+link+" @for: "+projectid);
		
	var data = {
		PROJECTID: projectid,
		DESC: desc,
		LINK: link,
		REIN: rein,
		RAUS: raus,
		DATE: dt.toString(),
		whichtable: 'TRANSACTIONS',
		CUD: 'create'
				};			// the CUD event to do.
					// ^if CUD == 'create', it will create OR update an object.
					// if CUD == 'delete', it will delete the object.
		
	// success function.
	var success = function(data)
	{
		console.log("CUD event result:" +data);
		deleteEntry("DECKELS",deckelid);
		//loadTable('deckels');
		// hideBlocker(); render will load all events and show blocker in the meanwhile.
	}

	$.ajax({
		type: 'POST',
		url: 'ajax_CUD_event.php',
		data: data,
		success: success,
		dataType: 'text'
	});
}

// load all deckels for a given deckel id, by name.
function loadDeckelsForID()
{
	var dar = getDeckelsForID(g_idToShow);
	
	if(dar.length<=0)
	{
		log("NO DECKELS FOUND!");
		return;
	}
	g_deckelName = dar[0].name;

	var fullbalanz = 0;

	var txt="";
	txt+=showTopBar(0);

	txt+="<h1>Deckel von "+dar[0].name+"</h1>";

	txt+=showDeckelStandards(0,true);

	var fullbalanz = 0.0;
	for(var i = 0; i < dar.length; i++)
	{
		var d = dar[i];
		txt+=showDeckelStandards(1,true,d);
		fullbalanz+=parseFloat(d.summe);
	}
	
	txt+='</table>';
	
	var deckel = "<div class='deckel'>"+parseFloat(fullbalanz).toFixed(2)+"</div>";
	
	document.getElementById("obergesamtfeld").innerHTML=deckel;
	document.getElementById("pagecontent").innerHTML=txt;
}

// show the deckels for a given project.
function showDeckels(projectid=-1)
{
	var parser = GMLParser.getParser("DataParser");
	var fullbalanz = 0;
	
	var txt="";
	txt+=showDeckelStandards(0,false,null,projectid);
	
	for(var i = 0; i < parser.deckels.length; i++)
	{
		var d = parser.deckels[i];
		if(projectid==-1 || d.projectid==projectid)
		{
			txt+=showDeckelStandards(1,false,d);
			fullbalanz+=parseFloat(d.summe);
		}
	}
	
	txt+='</table>';	
	txt="Deckelsumme: "+parseFloat(fullbalanz).toFixed(2)+"<br />"+txt;
	return txt;
}

// show all deckels
function deckelsLoaded()
{
	log("Deckels loaded.");
	g_deckelName = -1;
	var parser = GMLParser.getParser("DataParser");
	var fullbalanz = 0;

	var txt="";
	txt+=showTopBar(3);

	txt+=showDeckelStandards(0,false);

	var fullbalanz = 0;
	for(var i = 0; i < parser.deckels.length; i++)
	{
		var d = parser.deckels[i];
		txt+=showDeckelStandards(1,false,d);
		fullbalanz+=parseFloat(d.summe);
	}
	
	txt+='</table>';
	
	var deckel = "<div class='deckel'>"+parseFloat(fullbalanz).toFixed(2)+"</div>";
	
	document.getElementById("obergesamtfeld").innerHTML=deckel;
	document.getElementById("pagecontent").innerHTML=txt;
	showBlocker("", false);
}

loadTable('transactions');
</script>
</html>

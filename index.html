<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>VTI &lt;+&gt; Benis Finanzen</title>
<script src="jquery-3.3.1.min.js"></script>
<script src="gimli-parser.js"></script>
<script src="vti.js"></script>
<link href="https://fonts.googleapis.com/css?family=Permanent+Marker&display=swap" rel="stylesheet"> 
<style type="text/css">
	html, body
	{
		background-color: #FFFFFA;
		color: #000069;
	}
	.deckel
	{
		background-image: url('deckel.png');
		background-repeat: no-repeat;
		width: 220px;
		height: 220px;
		text-align: center;
		color: #3333CC;
		font-family: "Permanent Marker", serif;
		font-size: 30pt;
		padding-top: 80px;
	}
	.fw
	{
		min-width: 99%;
	}
	.tdr {text-align: right;}
	#ubermenu
	{
		padding-bottom: 10px;
		margin-bottom: 10px;
		border-bottom: 1px solid #FFFFFA;
		font-size: 15pt;
		font-weight: bold;
	}
	
	/* show the gesamt value also in the upper right.*/
	#obergesamtfeld
	{
		position: absolute;
		top: 10px;
		right: 10px;
	}

</style>
</head>
<body>
	<div id="pagetitle">
		<div id="title">
		<h1>Volle Transparenz Initiative</h1>
		<h2>Benis Projektfinanzen</h2>
		</div>
	</div>
	<div id="obergesamtfeld">Wert wird berechnet..</div>
	<div id="pagecontent">
		Bitte warten...Daten werden geladen.
	</div>
</body>

<script>

// show all transactions or only the ones for a specific project.
function showTransactions(proid)
{
	var parser = GMLParser.getParser("DataParser");

	var colsp = 4;
	
	var txt = "";
	txt+= '<table border="1">';
	txt+="<tr><td>";
	txt+="ID";
	txt+="</td><td>";
	txt+="Datum";
	txt+="</td><td>";
	txt+="Beschreibung";
	txt+="</td><td>";
	if(proid<0)
	{
		txt+="Projekt-ID";
		txt+="</td><td>";
		colsp+=1;
	}
	txt+="Produktlink";
	txt+="</td><td>";	
	txt+="REIN";
	txt+="</td><td>";
	txt+="RAUS";
	txt+="</td><td>";
	txt+="GESAMT";
	txt+="</td></tr>";

	var gesamtvalue = 0;
	var gesamtrein = 0;
	var gesamtraus = 0;
	for(var i = parser.transactions.length-1; i >0; i--)
	{
		var t = parser.transactions[i];
		if(proid>=0 && t.projectid!=proid)
			continue;
		txt+="<tr><td>";
		txt+=t.id;
		txt+="</td><td>";
		txt+=t.datum.getDate()+"."+(t.datum.getMonth()+1)+"."+t.datum.getFullYear();
		txt+="</td><td>";
		txt+=t.desc;
		if(proid<0)
		{
			var prname = getProjectByID(t.projectid).name
			txt+="</td><td><a href='javascript:' onclick='g_idToShow="+t.projectid+";singleProjectLoaded();'>["+t.projectid+"] "+prname+"</a>";
		}
		txt+="</td><td>";
		if(t.link.length>0)
		{
			txt+='<a href="'+t.link+'" target="vti_productlink">[Link]</a>';
		}else{
			txt+="---";
		}
		txt+="</td><td class='tdr'><font color='#00AA00'>";
		if(t.in!=0)
			txt+=Math.abs(t.in).toFixed(2);
		txt+="</font></td><td class='tdr'><font color='#FF3333'>";
		if(t.out!=0)
			txt+=Math.abs(t.out).toFixed(2);

		var col = "#00AA00";
		if(t.in-t.out<0)
			col="#FF3333";
		txt+="</font></td><td class='tdr'><font color='"+col+"'>";
		txt+=parseFloat(t.in-t.out).toFixed(2);
		txt+="</font></td>";
		txt+="</tr>";
		gesamtrein+=t.in;
		gesamtraus+=t.out;
		gesamtvalue+=t.in-t.out;
	}
	
	txt+='<tr>';
	txt+='<td colspan="'+colsp+'"></td>';
	col='#00AA00';
	gesamtrein = parseFloat(gesamtrein).toFixed(2);
	gesamtraus = parseFloat(gesamtraus).toFixed(2);
	gesamtvalue = parseFloat(gesamtvalue).toFixed(2);
	if(gesamtvalue<0)
		col='#FF3333';

	var gesamttxt = "";
	gesamttxt+='<td class="tdr"><font color="#00AA00">'+parseFloat(gesamtrein).toFixed(2)+'</font></td>';
	gesamttxt+='<td class="tdr"><font color="#FF3333">'+parseFloat(gesamtraus).toFixed(2)+'</font></td>';
	gesamttxt+='<td class="tdr"><font color="'+col+'">'+parseFloat(gesamtvalue).toFixed(2)+'</font></td>';
	gesamttxt+='</tr>';
	gesamttxt+='</table>';

	txt+=gesamttxt;
	
	var g = "<table border='1'><tr><td>REIN</td><td>RAUS</td><td>DIFF</td></tr><tr>"+gesamttxt;
	document.getElementById('obergesamtfeld').innerHTML=g;
	return txt;
}

function projectsLoaded()
{
	log("Projects loaded.");
	var parser = GMLParser.getParser("DataParser");

	var txt="";
	
	txt+=showTopBar(2);
	
	txt+='<table border="1">';
	txt+="<tr><td>";
	txt+="ID";
	txt+="</td><td>";
	txt+="Name";
	txt+="</td><td>";
	txt+="Beschreibung";
	txt+="</td><td>";
	txt+="Link";
	txt+="</td><td>";
	txt+="Balanz";
	txt+="</td></tr>";

	var fullbalanz = 0;
	var col = "";
	for(var i = 0; i < parser.projects.length; i++)
	{
		var p = parser.projects[i];
		txt+="<tr><td><a href='javascript:' onclick='g_idToShow="+p.id+";singleProjectLoaded();'>["+p.id+"]</a>";
		txt+="</td><td><a href='javascript:' onclick='g_idToShow="+p.id+";singleProjectLoaded();'>"+p.name+"</a>";
		var balanz = 0;
		col="#00AA00";
		for(var pq = 0; pq<parser.transactions.length;pq++)
		{
			var t = parser.transactions[pq];
			if(t.projectid==p.id)
			{
				balanz=balanz+t.in-t.out;
			}
		}
		if(balanz<0)
			col="#FF3333";
		txt+="</td><td>"+p.desc;
		txt+="</td><td><a href='"+p.link+"'>"+p.link+"</a>";
		txt+="</td><td class='tdr'><font color='"+col+"'>"+parseFloat(balanz).toFixed(2)+"</font>";
		txt+="</tr>";
		fullbalanz+=balanz;
	}
	col="#00AA00";
	if(fullbalanz<0)
		col="#FF3333";
	txt+='<tr><td colspan="4"></td><td class="tdr"><font color="'+col+'">'+parseFloat(fullbalanz).toFixed(2)+'</font></td><td></td></tr>';
	txt+='</table>';
	document.getElementById("obergesamtfeld").innerHTML="VOLLE BALANZ: <font color='"+col+"'>"+parseFloat(fullbalanz).toFixed(2)+"</font>";
	document.getElementById("pagecontent").innerHTML=txt;
}

function showDeckelStandards(which, ommitname=false,deckel = null)
{
	var txt="";
	// table header
	if(which==0)
	{
		txt+='<table border="1">';
		txt+="<tr><td>";
		txt+="ID";
		txt+="</td><td>";
		if(!ommitname)
		{
			txt+="Name";
			txt+="</td><td>";
		}
		txt+="Produkt";
		txt+="</td><td>";
		txt+="Projekt";
		txt+="</td><td>";
		txt+="Deckelsumme";
		txt+="</td></tr>";

	}
	// entry
	if(which==1)
	{
		txt+="<tr><td>"+deckel.id+"</a>";
		if(!ommitname)
			txt+="</td><td><a href='javascript:' onclick='g_idToShow="+deckel.id+";loadDeckelsForID();'>"+deckel.name+"</a>";
		
		txt+="</td><td>"+deckel.produkt;
		txt+="</td><td>["+deckel.projectid+"] "+getProjectByID(deckel.projectid).name;
		txt+="</td><td>"+parseFloat(deckel.summe).toFixed(2);
		txt+="</tr>";
	}
	return txt;
}

function loadDeckelsForID()
{
	var dar = getDeckelsForID(g_idToShow);
	
	if(dar.length<=0)
	{
		log("NO DECKELS FOUND!");
		return;
	}
	g_deckelName = dar[0].name;

	var fullbalanz = 0;

	var txt="";
	txt+=showTopBar(0);

	txt+="<h1>Deckel von "+dar[0].name+"</h1>";

	txt+=showDeckelStandards(0,true);

	var fullbalanz = 0.0;
	for(var i = 0; i < dar.length; i++)
	{
		var d = dar[i];
		txt+=showDeckelStandards(1,true,d);
		fullbalanz+=parseFloat(d.summe);
	}
	
	txt+='</table>';
	
	var deckel = "<div class='deckel'>"+parseFloat(fullbalanz).toFixed(2)+"</div>";
	
	document.getElementById("obergesamtfeld").innerHTML=deckel;
	document.getElementById("pagecontent").innerHTML=txt;
}

// show all deckels
function deckelsLoaded()
{
	log("Deckels loaded.");
	g_deckelName = -1;
	var parser = GMLParser.getParser("DataParser");
	var fullbalanz = 0;

	var txt="";
	txt+=showTopBar(3);

	txt+="Trivia: Auf der Scheibenwelt wurde für künftige Werte ein eigenes <a href='http://www.thediscworld.de/index.php/Zukunftsschweinelager'>Lagerhaus</a> gebaut.<br />";
	txt+=showDeckelStandards(0,false);

	var fullbalanz = 0;
	for(var i = 0; i < parser.deckels.length; i++)
	{
		var d = parser.deckels[i];
		txt+=showDeckelStandards(1,false,d);
		fullbalanz+=parseFloat(d.summe);
	}
	
	txt+='</table>';
	
	var deckel = "<div class='deckel'>"+parseFloat(fullbalanz).toFixed(2)+"</div>";
	
	document.getElementById("obergesamtfeld").innerHTML=deckel;
	document.getElementById("pagecontent").innerHTML=txt;
}

loadTable('transactions');
</script>
</html>
